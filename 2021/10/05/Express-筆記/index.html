<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Express 筆記 - Brian&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">



<meta name="keywords" content="Frontend,Backend,Linux,Python,React,react,react native,Java">



    <meta name="description" content="Express ConceptExpress is a bunch of middlewares works together Expresss Basic Routingconst express &#x3D; require(&#39;express&#39;);const app &#x3D; express();app.get(&#39;&#x2F;register&#39;, (req, res) &#x3D;&gt; {  const body &#x3D; req">
<meta property="og:type" content="article">
<meta property="og:title" content="Express 筆記">
<meta property="og:url" content="https://briancodeitup.blog/2021/10/05/Express-%E7%AD%86%E8%A8%98/index.html">
<meta property="og:site_name" content="Brian&#39;s Blog">
<meta property="og:description" content="Express ConceptExpress is a bunch of middlewares works together Expresss Basic Routingconst express &#x3D; require(&#39;express&#39;);const app &#x3D; express();app.get(&#39;&#x2F;register&#39;, (req, res) &#x3D;&gt; {  const body &#x3D; req">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/qtUrn4g.png">
<meta property="article:published_time" content="2021-10-05T07:36:07.000Z">
<meta property="article:modified_time" content="2021-11-09T16:14:02.038Z">
<meta property="article:author" content="Brian Chen">
<meta property="article:tag" content="express">
<meta property="article:tag" content="node.js">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/qtUrn4g.png">





<link rel="icon" href="/images/blog-icon.svg">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>



<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Brian
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/tags">標籤</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/BrianCodeItUp">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Express 筆記
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <span>10月 5 2021</span>
            
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><h2 id="Express-Concept"><a href="#Express-Concept" class="headerlink" title="Express Concept"></a>Express Concept</h2><p>Express is a bunch of middlewares works together</p>
<h2 id="Expresss-Basic-Routing"><a href="#Expresss-Basic-Routing" class="headerlink" title="Expresss Basic Routing"></a>Expresss Basic Routing</h2><figure class="highlight javascript hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/register'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> body = req.body;</span><br><span class="line">  <span class="hljs-keyword">const</span> isSucceed =  auth(body);</span><br><span class="line">  <span class="hljs-keyword">if</span> (isSucceed) {</span><br><span class="line">    res.send(<span class="hljs-string">'Register Successfully'</span>);</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    res.status(<span class="hljs-number">443</span>).sene(<span class="hljs-string">'Authentication fail, unable to register'</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<span id="more"></span>

<h2 id="Apply-Middleware"><a href="#Apply-Middleware" class="headerlink" title="Apply Middleware"></a>Apply Middleware</h2><figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateUser</span>(<span class="hljs-params">req, res, next</span>) </span>{</span><br><span class="line">	res.locals.validated = <span class="hljs-literal">true</span>;</span><br><span class="line">	next()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Apply the middleware to all method at route '/'</span></span><br><span class="line">app.use(<span class="hljs-string">'/'</span> ,validateUser)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Apply the middleware to "GET" method at route '/'</span></span><br><span class="line">app.get(<span class="hljs-string">'/'</span>, validateUser)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="hljs-number">3000</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Use-the-built-in-middleware"><a href="#Use-the-built-in-middleware" class="headerlink" title="Use the built-in middleware"></a>Use the built-in middleware</h2><ul>
<li><code>express.json()</code> : 解析 conten-type 是 <code>application/json</code> 的 request</li>
<li><code>express.urlencoded()</code> : 解析 conten-type 是 <code>application/x-www-form-urlencoded</code> 的 request , 最常見 POST 提交數據的方式，瀏覽器的原生</li>
</ul>
<p>表單，如果沒有設置 enctype 屬性，就會以默認以此方式提交數據</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">POST &lt;http:<span class="hljs-comment">//www.example.com&gt; HTTP/1.1</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded;charset=utf-<span class="hljs-number">8</span></span><br><span class="line">title=test&amp;sub%5B%5D=<span class="hljs-number">1</span>&amp;sub%5B%5D=<span class="hljs-number">2</span>&amp;sub%5B%5D=<span class="hljs-number">3</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>通過使用以上內件的 middleware, 我們就可以在 res.body 得到前端 POST 過來的資料</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.use(express.json())</span><br><span class="line">app.use(express.urlencoding())</span><br><span class="line"></span><br><span class="line">app.post(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">	<span class="hljs-keyword">const</span> data = res.body</span><br><span class="line">	res.send(<span class="hljs-string">'&lt;h1&gt;I got the data&lt;/h1&gt;'</span>)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Servering-static-content"><a href="#Servering-static-content" class="headerlink" title="Servering static content"></a>Servering static content</h2><ul>
<li><code>express.static</code>: serving specified folder</li>
</ul>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// express.staic 也是內建的 middleware</span></span><br><span class="line">app.use(express.static(<span class="hljs-string">'public'</span>))</span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用-helmet-增加-server-安全性"><a href="#使用-helmet-增加-server-安全性" class="headerlink" title="使用 helmet 增加 server 安全性"></a>使用 helmet 增加 server 安全性</h2><p><a target="_blank" rel="noopener" href="https://expressjs.com/zh-tw/advanced/best-practice-security.html">express 文件</a></p>
<p>使用 <a target="_blank" rel="noopener" href="https://github.com/helmetjs/helmet">Helemt</a></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">npm install --save helmet</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Using-View-engine"><a href="#Using-View-engine" class="headerlink" title="Using View engine"></a>Using View engine</h2><p>熱門的 view engine 選項有</p>
<ul>
<li>pug</li>
<li>handlebars: <code>npm i hbs</code></li>
<li>mustache</li>
<li>ejs</li>
</ul>
<p>使用前要用 npm 安裝</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">npm install pug --save</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 告知 express, 我們要使用 pug 做 view engine</span></span><br><span class="line">app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'pug'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 可以設定 view template 放在哪個檔案夾 , 預設會去讀同一層目錄的 views 檔案夾</span></span><br><span class="line"><span class="hljs-comment">// app.set('views', path.join(__dirname, 'views'))</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">res, res</span>) =&gt;</span> {</span><br><span class="line">	res.render(<span class="hljs-string">'index'</span>)</span><br><span class="line">})</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="傳值到-view-template-裡"><a href="#傳值到-view-template-裡" class="headerlink" title="傳值到 view template 裡"></a>傳值到 view template 裡</h3><figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 告知 express, 我們要使用 pug 做 view engine</span></span><br><span class="line">app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">res, res</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-comment">// 後面的參數其實都被放到 res.locals 裡面了</span></span><br><span class="line">  res.render(<span class="hljs-string">'index'</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'Hey'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello there!'</span>});</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext hljs"><table><tbody><tr><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title= title</span><br><span class="line">  body</span><br><span class="line">    h1= message</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Handle-cookies"><a href="#Handle-cookies" class="headerlink" title="Handle cookies"></a>Handle cookies</h2><h3 id="setCookies"><a href="#setCookies" class="headerlink" title="setCookies"></a>setCookies</h3><figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.post(<span class="hljs-string">'/proccess_login'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> userName = req.body.userName;</span><br><span class="line">  <span class="hljs-keyword">const</span> password = req.body.password;</span><br><span class="line">  <span class="hljs-keyword">if</span> (password === correctPassword) {</span><br><span class="line">    res.cookie(<span class="hljs-string">'userName'</span>, userName);</span><br><span class="line">      res.redirect(<span class="hljs-string">'/welcome'</span>)</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    res.redirect(<span class="hljs-string">'/login?msg=fail'</span>)</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h3 id="parseCookies"><a href="#parseCookies" class="headerlink" title="parseCookies"></a>parseCookies</h3><p>Install cookie-parser</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="code"><pre><span class="line">npm install cookie-parser</span><br></pre></td></tr></tbody></table></figure>

<p>Apply cookie-parser as middleware</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"><span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> app = express()</span><br><span class="line">app.use(cookieParser())</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// Cookies that have not been signed</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Cookies: '</span>, req.cookies)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// Cookies that have been signed</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Signed Cookies: '</span>, req.signedCookies)</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">app.listen(<span class="hljs-number">8080</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="設定-Cookie-案例"><a href="#設定-Cookie-案例" class="headerlink" title="設定 Cookie 案例"></a>設定 Cookie 案例</h3><p>我們平常在用 express 時都是回傳 JSON 格式，所以 express 會直接幫我們在 header 帶入 </p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="code"><pre><span class="line">Content-Type: 'application/json'</span><br></pre></td></tr></tbody></table></figure>

<p>但是如果我們今天要回傳圖片，我們就可以設定 Content-Type 為 image/jpg 格式</p>
<p>舉例，今天使用者要取的自己的大頭貼圖片</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/user/me/avatar'</span>, auth, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {</span><br><span class="line">  res.set(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'image/jpg'</span>);</span><br><span class="line">  <span class="hljs-comment">// user 物件裡的 avatar 屬性是的 base64 圖片資料</span></span><br><span class="line">  res.send(req.user.avatar)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Handle-Cookie-and-Session"><a href="#Handle-Cookie-and-Session" class="headerlink" title="Handle Cookie and Session"></a>Handle Cookie and Session</h2><p>在做用戶驗證時，常用的驗證方式之一是 Session Based 的驗證方式，簡單來說就是當用戶登入成功後，我們在將一些驗證成功的資料放在入 cookie 讓之後的 client 的 request 都帶著這個 cookie 來讓 server 進行辨識，其中有兩種做法</p>
<ol>
<li>將用戶資訊加密後放入 cookie 中, 可使用 <a target="_blank" rel="noopener" href="https://github.com/expressjs/cookie-session#readme">cookie-session</a> 套件來完成</li>
<li>在 server 產生 session id，cookie 中只帶 session id, 用戶資料會存在另一個 Server 端的 DB (Redis), 每次 request 透過 session id 來辨識使用者，可以用 <a target="_blank" rel="noopener" href="https://github.com/expressjs/session#readme">express-session</a> 套件完成</li>
</ol>
<h2 id="Pass-data-from-URL"><a href="#Pass-data-from-URL" class="headerlink" title="Pass data from URL"></a>Pass data from URL</h2><h3 id="Query-string"><a href="#Query-string" class="headerlink" title="Query string"></a>Query string</h3><p>假設前端 request url 為: <code>https://{your_domain_name}/product?productId=abc13&amp;productStatus=onSell</code></p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/product'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> query = req.query;</span><br><span class="line">  <span class="hljs-keyword">const</span> productId = query.productId;</span><br><span class="line">  <span class="hljs-keyword">const</span> productStatus = query.productStatus;</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>在 redirect 時加入 params</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.post(<span class="hljs-string">'/proccess_login'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> userName = req.body.userName;</span><br><span class="line">  <span class="hljs-keyword">const</span> password = req.body.password;</span><br><span class="line">  <span class="hljs-keyword">if</span> (password === correctPassword) {</span><br><span class="line">    res.cookie(<span class="hljs-string">'userName'</span>, userName);</span><br><span class="line">    res.redirect(<span class="hljs-string">'/welcome'</span>)</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    res.redirect(<span class="hljs-string">'/login?msg=fail'</span>)</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h3 id="WildCards"><a href="#WildCards" class="headerlink" title="WildCards"></a>WildCards</h3><p>假設前端 request url 為: <code>https://{your_domain_name}/abc123/onSell</code></p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/product/:productId/:productStatus:'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> productId = req.params.productId;</span><br><span class="line">  <span class="hljs-keyword">const</span> productStatus = req.params.productStatus;</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Pagination-分頁）"><a href="#Pagination-分頁）" class="headerlink" title="Pagination(分頁）"></a>Pagination(分頁）</h3><p>透過 Query String 給 API 要 filter 的條件</p>
<ul>
<li>GET <code>/task?completed=true</code> 只要取得完成的 task</li>
<li>GET <code>/task?limit=10&amp;skip=10</code> 只拿 10 筆，並且跳過前十筆</li>
</ul>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">router.ger(<span class="hljs-string">'/tasks'</span>, auth, <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">const</span> query = req.query</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Download-files"><a href="#Download-files" class="headerlink" title="Download files"></a>Download files</h2><figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/statement'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-comment">// res.download 第二個參數可以改下載檔案的名稱</span></span><br><span class="line">  res.download(path.join(__dirname, <span class="hljs-string">'userStatements/BankStatement.png'</span>))</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>express 其實只是把 header 改掉，然後呼叫 <code>res.sendFile()</code></p>
<p><img src="https://i.imgur.com/qtUrn4g.png" alt="https://i.imgur.com/qtUrn4g.png"></p>
<p>如果你只要將 header 的 content-disposition 改為 attchment 可以改用 <code>res.attachment()</code></p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/statement'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">	res.attachment(path.join(__dirname, <span class="hljs-string">'userStatements/BankStatement.png'</span>))</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>檔案下載錯誤處裡, 通常錯誤發生時 response 可能已經回了，所以不能在 callback 裡面再重新送一次, 可以利用 <code>res.headersSent</code> 檢查 header 是否已送出</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/statement'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line"> <span class="hljs-comment">// res.download 第二個參數可以改下載檔案的名稱</span></span><br><span class="line">	res.download(</span><br><span class="line">		path.join(__dirname, <span class="hljs-string">'userStatements/BankStatement.png'</span>),</span><br><span class="line">	 <span class="hljs-string">'BrianStatement'</span>,</span><br><span class="line">		<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</span><br><span class="line">				<span class="hljs-keyword">if</span> (error) {</span><br><span class="line"> 					<span class="hljs-comment">//	res.headersSent is a bool, true if headers are already sent</span></span><br><span class="line">					<span class="hljs-keyword">if</span> (！res.headersSent) {</span><br><span class="line">	          res.redirect(<span class="hljs-string">'/download/error'</span>)</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">		}</span><br><span class="line">	)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><p>express 提供，用來拆分 route 的 middleware</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> { User } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models"</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Create user</span></span><br><span class="line">router.post(<span class="hljs-string">'/users'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> User(req.body);</span><br><span class="line">    <span class="hljs-keyword">try</span> {</span><br><span class="line">        <span class="hljs-keyword">const</span> savedUser = <span class="hljs-keyword">await</span> user.save()</span><br><span class="line">        res.status(<span class="hljs-number">201</span>).send(savedUser);</span><br><span class="line">    } <span class="hljs-keyword">catch</span> (e) {</span><br><span class="line">        res.status(<span class="hljs-number">400</span>).send(e);</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>向 express 註冊 Router</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> app = exprss()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> userRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/userRouter'</span>)</span><br><span class="line"></span><br><span class="line">app.use(userRouter)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Handle-Http-headers-in-Express"><a href="#Handle-Http-headers-in-Express" class="headerlink" title="Handle Http headers in Express"></a>Handle Http headers in Express</h2><h3 id="Set-header"><a href="#Set-header" class="headerlink" title="Set header"></a>Set header</h3><figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">	<span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1969</span>, <span class="hljs-number">6</span>, <span class="hljs-number">20</span>)</span><br><span class="line">	res.set(<span class="hljs-string">'Date'</span>, date)</span><br><span class="line">	res.set(<span class="hljs-string">'Context-Type'</span>, <span class="hljs-string">'text/plain'</span>)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Uploading-files-to-Express-with-Multer"><a href="#Uploading-files-to-Express-with-Multer" class="headerlink" title="Uploading files to Express with Multer"></a>Uploading files to Express with Multer</h2><p>上傳圖片的格式是 <code>multipart/form-data</code></p>
<p>可以用 <a target="_blank" rel="noopener" href="https://github.com/expressjs/multer">multer</a> 來 parse 檔案</p>
<p>假設我們有一個 form 可以上傳檔案</p>
<figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="line">	<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">'post'</span> <span class="hljs-attr">action</span>=<span class="hljs-string">'formsub'</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">'multipart/form-data'</span>&gt;</span></span><br><span class="line">		<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'file'</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"meme"</span> /&gt;</span></span><br><span class="line">	<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>上傳單個檔案，檔案名稱需為 meme</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"><span class="hljs-keyword">const</span> upload = multer({</span><br><span class="line">	<span class="hljs-attr">dest</span>: <span class="hljs-string">'public/images/uploads'</span>,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.post(<span class="hljs-string">'/formsub'</span>, upload.single(<span class="hljs-string">'meme'</span>),<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">	<span class="hljs-keyword">const</span> fileData = req.file;</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h3 id="限制-Upload-大小、檔案類型"><a href="#限制-Upload-大小、檔案類型" class="headerlink" title="限制 Upload 大小、檔案類型"></a>限制 Upload 大小、檔案類型</h3><p><strong>使用 <code>limits</code> option 去限制上傳檔案大小</strong></p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> upload = multer({</span><br><span class="line">  <span class="hljs-attr">dest</span>: <span class="hljs-string">'images'</span>,</span><br><span class="line">  <span class="hljs-attr">limits</span>: {</span><br><span class="line">    <span class="hljs-comment">// 1 million bytes</span></span><br><span class="line">    <span class="hljs-attr">fileSize</span>: <span class="hljs-number">1000000</span>,</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.post(<span class="hljs-string">'/upload'</span>, upload.single(<span class="hljs-string">'upload'</span>), <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {</span><br><span class="line">  res.send();</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p><strong>使用 <code>fileFilter</code> option</strong> </p>
<p>multer 提供三個參數給你用 <code>fileFilter(req, file, cb)</code></p>
<p>第三個 <code>cb</code> 參數比較特別，</p>
<ul>
<li>如果你接收這個檔案: <code>cb(null, true)</code></li>
<li>如果你拒絕接收這個檔案： <code>cb(null, false)</code></li>
<li>如果你想 throw 錯誤給 client： <code>cb(new Error('給 client 的錯誤'))</code></li>
</ul>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> upload = multer({</span><br><span class="line">  <span class="hljs-attr">dest</span>: <span class="hljs-string">'images'</span>,</span><br><span class="line">  <span class="hljs-attr">limits</span>: {</span><br><span class="line">    <span class="hljs-comment">// 1 million bytes</span></span><br><span class="line">    <span class="hljs-attr">fileSize</span>: <span class="hljs-number">1000000</span></span><br><span class="line">  },</span><br><span class="line">  <span class="hljs-function"><span class="hljs-title">fileFilter</span>(<span class="hljs-params">req, file, cb</span>)</span> {</span><br><span class="line">    <span class="hljs-keyword">if</span> (!file.originalname.endsWith(<span class="hljs-string">'.pdf'</span>)) {</span><br><span class="line">      <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Please upload a PDF'</span>))</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p><strong>使用 <code>storage</code> option 將設定為 <code>memoryStorage</code></strong></p>
<p>這個選項會存在記憶體中的選項轉為 <code>Buffer</code> 格式，可以透過 <code>req.file.buffer</code> 取得檔案 buffer</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> storage = multer.memoryStorage()</span><br><span class="line"><span class="hljs-keyword">const</span> upload = multer({ <span class="hljs-attr">storage</span>: storage })</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> upload = multer({</span><br><span class="line">  <span class="hljs-function"><span class="hljs-title">fileFilter</span>(<span class="hljs-params">req, file, cb</span>)</span> {</span><br><span class="line">    <span class="hljs-keyword">if</span> (!file.originalname.endsWith(<span class="hljs-string">'.pdf'</span>)) {</span><br><span class="line">      <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Please upload a PDF'</span>))</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);</span><br><span class="line">  },</span><br><span class="line">	storage</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.post(<span class="hljs-string">'/users/me/avatar'</span>, auth, upload.single(<span class="hljs-string">'avatar'</span>), <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">    req.user.avatar = req.file.buffer;</span><br><span class="line">    <span class="hljs-keyword">await</span> req.user.save();</span><br><span class="line">    res.send(<span class="hljs-string">'ok'</span>);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Handling-Express-Errors"><a href="#Handling-Express-Errors" class="headerlink" title="Handling Express Errors"></a>Handling Express Errors</h2><p>如果前面 middleware 丟出錯誤，我們可以新增 <strong>Error Handling Middleware</strong></p>
<p>Error Handling Middleware, <strong>與一般 middleware 的差別是</strong></p>
<p><strong>只有在 call signature 都是四個參數的的情況下，express 才會認定這是 error handling middleware,並且 call 這個 function</strong></p>
<p>以下例子，我們先加上一個直接丟錯誤的 middleware 在 route handler 的前面, 後面加上再加上Error Handling Middleware</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> errorMiddleware = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {</span><br><span class="line">	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'From my middleware'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">app.post(<span class="hljs-string">'/upload'</span>, errorMiddleware, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {</span><br><span class="line">		res.send(<span class="hljs-string">'ok'</span>)</span><br><span class="line">}, <span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {</span><br><span class="line">	res.status(<span class="hljs-number">500</span>).send({ <span class="hljs-attr">error</span>: error.message })</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>當實際執行可以發現當 error 被 throw 後 ，route handler 被跳過了，直接執行 Error Handling Middleware</p>
<p>其他細節和用法可以參考 express 文件:</p>
<p><a target="_blank" rel="noopener" href="https://expressjs.com/zh-tw/guide/error-handling.html">錯誤處理</a></p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/express/">#express</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/node-js/">#node.js</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/10/06/%E4%BD%BF%E7%94%A8-apollo-studio-%E8%88%87-express-session-%E7%84%A1%E6%B3%95-setCookie-%E5%95%8F%E9%A1%8C/">使用 apollo-studio 與 express-session 無法 set-cookie 問題</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/10/01/%E5%A6%82%E4%BD%95%E5%9C%A8-React-Native-%E5%B0%88%E6%A1%88%E6%96%B0%E5%A2%9E-iOS-Widgets/">如何在 React Native 專案新增 iOS Widgets</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Brian Chen&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/BrianCodeItUp">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>




<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>